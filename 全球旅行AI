<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒæ—…æ¸¸è§„åˆ’åŠ©æ‰‹</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è®¾ç½®é»˜è®¤å­—ä½“ä¸º Interï¼Œå¹¶å¯ç”¨ä¸­æ–‡å‹å¥½å­—ä½“ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #f7f9fb;
        }
        /* é’ˆå¯¹ä¸‹æ‹‰æ¡†ä¸­çš„å¤§é‡é€‰é¡¹ï¼Œç¡®ä¿æ»šåŠ¨å‹å¥½ */
        #countrySelect {
            max-height: 400px; /* é™åˆ¶é«˜åº¦ï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´åƒä¸€ä¸ªè¾“å…¥æ¡†è€Œä¸æ˜¯ä¸€ä¸ªå·¨å¤§çš„åˆ—è¡¨ */
            appearance: none; /* ç§»é™¤é»˜è®¤çš„ç³»ç»Ÿæ ·å¼ */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%236B7280'%3e%3cpath d='M6 8l4 4 4-4' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* ä¸ºå›¾æ ‡ç•™å‡ºç©ºé—´ */
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div id="app" class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 sm:p-10 border border-indigo-100">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-700 mb-2 text-center">
            ğŸŒ å…¨çƒæ—…è¡ŒæŒ‡å— (å…¨é¢ç‰ˆ)
        </h1>
        <p class="text-center text-gray-500 mb-8">
            é€‰æ‹©å…¨çƒä»»ä¸€å›½å®¶ï¼Œå¹¶è¾“å…¥æ‚¨çš„æ—…è¡Œç–‘é—®ï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›æœ€æ–°ä¿¡æ¯ã€‚
        </p>

        <!-- é€‰æ‹©å›½å®¶å’ŒæŸ¥è¯¢è¾“å…¥åŒºåŸŸ -->
        <div class="space-y-6">
            <!-- å›½å®¶é€‰æ‹©ä¸‹æ‹‰æ¡† -->
            <div>
                <label for="countrySelect" class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©æ‚¨çš„ç›®çš„åœ°å›½å®¶ï¼š</label>
                <select id="countrySelect" class="w-full p-3 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out bg-white">
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <!-- æ—…è¡ŒæŸ¥è¯¢è¾“å…¥æ¡† -->
            <div>
                <label for="queryInput" class="block text-sm font-medium text-gray-700 mb-2">æ‚¨çš„æ—…è¡Œé—®é¢˜ï¼ˆä¾‹å¦‚ï¼šå¿…å»æ™¯ç‚¹ã€é¢„ç®—ä¼°ç®—ã€ç­¾è¯è¦æ±‚ï¼‰ï¼š</label>
                <input type="text" id="queryInput" placeholder="è¾“å…¥æ‚¨çš„å…·ä½“é—®é¢˜..."
                       class="w-full p-3 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                       value="å†°å²›æ‰“å·¥åº¦å‡çš„æœ€æ–°ç­¾è¯è¦æ±‚">
            </div>

            <!-- ç”ŸæˆæŒ‰é’® -->
            <button id="generateBtn"
                    class="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 shadow-md transition duration-150 ease-in-out disabled:opacity-50"
                    disabled>
                è·å–æ—…è¡Œå»ºè®®
            </button>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div id="resultsContainer" class="mt-10 pt-8 border-t border-indigo-200">
            <div id="loadingIndicator" class="hidden text-center">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full"></div>
                <p class="mt-2 text-indigo-600 font-medium">AI æ­£åœ¨ä¸ºæ‚¨æ£€ç´¢å’Œæ€»ç»“æœ€æ–°ä¿¡æ¯ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div id="responseText" class="text-gray-800 space-y-4">
                <!-- AI ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>

            <div id="sourcesContainer" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                <p class="text-sm font-semibold text-gray-700 mb-2">ä¿¡æ¯æ¥æº (Google Search Grounding):</p>
                <ul id="sourcesList" class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                    <!-- å¼•ç”¨é“¾æ¥å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        // --- é…ç½®å’Œæ•°æ® ---
        const API_KEY = ""; // Canvas runtime will inject the API key if needed
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // å…¨çƒæ‰€æœ‰å›½å®¶çš„åˆ—è¡¨ (åŒ…å«ç”¨æˆ·ä¸Šæ¬¡æ·»åŠ çš„å›½å®¶)
        const ALL_COUNTRIES = [
            // é‡ç‚¹å…³æ³¨å’Œä¸Šæ¬¡æ·»åŠ çš„å›½å®¶ä¼˜å…ˆ
            { name: 'å†°å²›', code: 'Iceland' },
            { name: 'ä¸­å›½', code: 'China' },
            { name: 'ç¾å›½', code: 'United States' },
            { name: 'æ³•å›½', code: 'France' },
            { name: 'å¾·å›½', code: 'Germany' },
            { name: 'æ³°å›½', code: 'Thailand' },
            { name: 'æ¾³å¤§åˆ©äºš', code: 'Australia' },
            { name: 'æ–°è¥¿å…°', code: 'New Zealand' },
            // å®Œæ•´çš„ISOå›½å®¶åˆ—è¡¨ (ç®€åŒ–ä¸­æ–‡åç§°)
            { name: 'é˜¿å¯Œæ±—', code: 'Afghanistan' },
            { name: 'é˜¿å°”å·´å°¼äºš', code: 'Albania' },
            { name: 'é˜¿å°”åŠåˆ©äºš', code: 'Algeria' },
            { name: 'å®‰é“å°”', code: 'Andorra' },
            { name: 'å®‰å“¥æ‹‰', code: 'Angola' },
            { name: 'å®‰æç“œå’Œå·´å¸ƒè¾¾', code: 'Antigua and Barbuda' },
            { name: 'é˜¿æ ¹å»·', code: 'Argentina' },
            { name: 'äºšç¾å°¼äºš', code: 'Armenia' },
            { name: 'å¥¥åœ°åˆ©', code: 'Austria' },
            { name: 'é˜¿å¡æ‹œç–†', code: 'Azerbaijan' },
            { name: 'å·´å“ˆé©¬', code: 'Bahamas' },
            { name: 'å·´æ—', code: 'Bahrain' },
            { name: 'å­ŸåŠ æ‹‰å›½', code: 'Bangladesh' },
            { name: 'å·´å·´å¤šæ–¯', code: 'Barbados' },
            { name: 'ç™½ä¿„ç½—æ–¯', code: 'Belarus' },
            { name: 'æ¯”åˆ©æ—¶', code: 'Belgium' },
            { name: 'ä¼¯åˆ©å…¹', code: 'Belize' },
            { name: 'è´å®', code: 'Benin' },
            { name: 'ä¸ä¸¹', code: 'Bhutan' },
            { name: 'ç»åˆ©ç»´äºš', code: 'Bolivia' },
            { name: 'æ³¢æ–¯å°¼äºšå’Œé»‘å¡å“¥ç»´é‚£', code: 'Bosnia and Herzegovina' },
            { name: 'åšèŒ¨ç“¦çº³', code: 'Botswana' },
            { name: 'å·´è¥¿', code: 'Brazil' },
            { name: 'æ–‡è±', code: 'Brunei' },
            { name: 'ä¿åŠ åˆ©äºš', code: 'Bulgaria' },
            { name: 'å¸ƒåŸºçº³æ³•ç´¢', code: 'Burkina Faso' },
            { name: 'å¸ƒéš†è¿ª', code: 'Burundi' },
            { name: 'ä½›å¾—è§’', code: 'Cabo Verde' },
            { name: 'æŸ¬åŸ”å¯¨', code: 'Cambodia' },
            { name: 'å–€éº¦éš†', code: 'Cameroon' },
            { name: 'åŠ æ‹¿å¤§', code: 'Canada' },
            { name: 'ä¸­éå…±å’Œå›½', code: 'Central African Republic' },
            { name: 'ä¹å¾—', code: 'Chad' },
            { name: 'æ™ºåˆ©', code: 'Chile' },
            { name: 'å“¥ä¼¦æ¯”äºš', code: 'Colombia' },
            { name: 'ç§‘æ‘©ç½—', code: 'Comoros' },
            { name: 'åˆšæœï¼ˆå¸ƒï¼‰', code: 'Congo-Brazzaville' },
            { name: 'åˆšæœï¼ˆé‡‘ï¼‰', code: 'Congo-Kinshasa' },
            { name: 'å“¥æ–¯è¾¾é»åŠ ', code: 'Costa Rica' },
            { name: 'ç§‘ç‰¹è¿ªç“¦', code: 'Cote dIvoire' },
            { name: 'å…‹ç½—åœ°äºš', code: 'Croatia' },
            { name: 'å¤å·´', code: 'Cuba' },
            { name: 'å¡æµ¦è·¯æ–¯', code: 'Cyprus' },
            { name: 'æ·å…‹', code: 'Czech Republic' },
            { name: 'ä¸¹éº¦', code: 'Denmark' },
            { name: 'å‰å¸ƒæ', code: 'Djibouti' },
            { name: 'å¤šç±³å°¼å…‹', code: 'Dominica' },
            { name: 'å¤šç±³å°¼åŠ å…±å’Œå›½', code: 'Dominican Republic' },
            { name: 'å„ç“œå¤šå°”', code: 'Ecuador' },
            { name: 'åŸƒåŠ', code: 'Egypt' },
            { name: 'è¨å°”ç“¦å¤š', code: 'El Salvador' },
            { name: 'èµ¤é“å‡ å†…äºš', code: 'Equatorial Guinea' },
            { name: 'å„ç«‹ç‰¹é‡Œäºš', code: 'Eritrea' },
            { name: 'çˆ±æ²™å°¼äºš', code: 'Estonia' },
            { name: 'æ–¯å¨å£«å…°', code: 'Eswatini' },
            { name: 'åŸƒå¡ä¿„æ¯”äºš', code: 'Ethiopia' },
            { name: 'æ–æµ', code: 'Fiji' },
            { name: 'èŠ¬å…°', code: 'Finland' },
            { name: 'åŠ è“¬', code: 'Gabon' },
            { name: 'å†ˆæ¯”äºš', code: 'Gambia' },
            { name: 'æ ¼é²å‰äºš', code: 'Georgia' },
            { name: 'åŠ çº³', code: 'Ghana' },
            { name: 'å¸Œè…Š', code: 'Greece' },
            { name: 'æ ¼æ—çº³è¾¾', code: 'Grenada' },
            { name: 'å±åœ°é©¬æ‹‰', code: 'Guatemala' },
            { name: 'å‡ å†…äºš', code: 'Guinea' },
            { name: 'å‡ å†…äºšæ¯”ç»', code: 'Guinea-Bissau' },
            { name: 'åœ­äºšé‚£', code: 'Guyana' },
            { name: 'æµ·åœ°', code: 'Haiti' },
            { name: 'æ´ªéƒ½æ‹‰æ–¯', code: 'Honduras' },
            { name: 'åŒˆç‰™åˆ©', code: 'Hungary' },
            { name: 'å°åº¦', code: 'India' },
            { name: 'å°åº¦å°¼è¥¿äºš', code: 'Indonesia' },
            { name: 'ä¼Šæœ—', code: 'Iran' },
            { name: 'ä¼Šæ‹‰å…‹', code: 'Iraq' },
            { name: 'çˆ±å°”å…°', code: 'Ireland' },
            { name: 'ä»¥è‰²åˆ—', code: 'Israel' },
            { name: 'æ„å¤§åˆ©', code: 'Italy' },
            { name: 'ç‰™ä¹°åŠ ', code: 'Jamaica' },
            { name: 'æ—¥æœ¬', code: 'Japan' },
            { name: 'çº¦æ—¦', code: 'Jordan' },
            { name: 'å“ˆè¨å…‹æ–¯å¦', code: 'Kazakhstan' },
            { name: 'è‚¯å°¼äºš', code: 'Kenya' },
            { name: 'åŸºé‡Œå·´æ–¯', code: 'Kiribati' },
            { name: 'ç§‘å¨ç‰¹', code: 'Kuwait' },
            { name: 'å‰å°”å‰æ–¯æ–¯å¦', code: 'Kyrgyzstan' },
            { name: 'è€æŒ', code: 'Laos' },
            { name: 'æ‹‰è„±ç»´äºš', code: 'Latvia' },
            { name: 'é»å·´å«©', code: 'Lebanon' },
            { name: 'è±ç´¢æ‰˜', code: 'Lesotho' },
            { name: 'åˆ©æ¯”é‡Œäºš', code: 'Liberia' },
            { name: 'åˆ©æ¯”äºš', code: 'Libya' },
            { name: 'åˆ—æ”¯æ•¦å£«ç™»', code: 'Liechtenstein' },
            { name: 'ç«‹é™¶å®›', code: 'Lithuania' },
            { name: 'å¢æ£®å ¡', code: 'Luxembourg' },
            { name: 'é©¬è¾¾åŠ æ–¯åŠ ', code: 'Madagascar' },
            { name: 'é©¬æ‹‰ç»´', code: 'Malawi' },
            { name: 'é©¬æ¥è¥¿äºš', code: 'Malaysia' },
            { name: 'é©¬å°”ä»£å¤«', code: 'Maldives' },
            { name: 'é©¬é‡Œ', code: 'Mali' },
            { name: 'é©¬è€³ä»–', code: 'Malta' },
            { name: 'é©¬ç»å°”ç¾¤å²›', code: 'Marshall Islands' },
            { name: 'æ¯›é‡Œå¡”å°¼äºš', code: 'Mauritania' },
            { name: 'æ¯›é‡Œæ±‚æ–¯', code: 'Mauritius' },
            { name: 'å¢¨è¥¿å“¥', code: 'Mexico' },
            { name: 'å¯†å…‹ç½—å°¼è¥¿äºš', code: 'Micronesia' },
            { name: 'æ‘©å°”å¤šç“¦', code: 'Moldova' },
            { name: 'æ‘©çº³å“¥', code: 'Monaco' },
            { name: 'è’™å¤', code: 'Mongolia' },
            { name: 'é»‘å±±', code: 'Montenegro' },
            { name: 'æ‘©æ´›å“¥', code: 'Morocco' },
            { name: 'è«æ¡‘æ¯”å…‹', code: 'Mozambique' },
            { name: 'ç¼…ç”¸', code: 'Myanmar' },
            { name: 'çº³ç±³æ¯”äºš', code: 'Namibia' },
            { name: 'ç‘™é²', code: 'Nauru' },
            { name: 'å°¼æ³Šå°”', code: 'Nepal' },
            { name: 'è·å…°', code: 'Netherlands' },
            { name: 'å°¼åŠ æ‹‰ç“œ', code: 'Nicaragua' },
            { name: 'å°¼æ—¥å°”', code: 'Niger' },
            { name: 'å°¼æ—¥åˆ©äºš', code: 'Nigeria' },
            { name: 'æœé²œ', code: 'North Korea' },
            { name: 'åŒ—é©¬å…¶é¡¿', code: 'North Macedonia' },
            { name: 'æŒªå¨', code: 'Norway' },
            { name: 'é˜¿æ›¼', code: 'Oman' },
            { name: 'å·´åŸºæ–¯å¦', code: 'Pakistan' },
            { name: 'å¸•åŠ³', code: 'Palau' },
            { name: 'å·´å‹’æ–¯å¦', code: 'Palestine' },
            { name: 'å·´æ‹¿é©¬', code: 'Panama' },
            { name: 'å·´å¸ƒäºšæ–°å‡ å†…äºš', code: 'Papua New Guinea' },
            { name: 'å·´æ‹‰åœ­', code: 'Paraguay' },
            { name: 'ç§˜é²', code: 'Peru' },
            { name: 'è²å¾‹å®¾', code: 'Philippines' },
            { name: 'æ³¢å…°', code: 'Poland' },
            { name: 'è‘¡è„ç‰™', code: 'Portugal' },
            { name: 'å¡å¡”å°”', code: 'Qatar' },
            { name: 'ç½—é©¬å°¼äºš', code: 'Romania' },
            { name: 'ä¿„ç½—æ–¯', code: 'Russia' },
            { name: 'å¢æ—ºè¾¾', code: 'Rwanda' },
            { name: 'åœ£åŸºèŒ¨å’Œå°¼ç»´æ–¯', code: 'Saint Kitts and Nevis' },
            { name: 'åœ£å¢è¥¿äºš', code: 'Saint Lucia' },
            { name: 'åœ£æ–‡æ£®ç‰¹å’Œæ ¼æ—çº³ä¸æ–¯', code: 'Saint Vincent and the Grenadines' },
            { name: 'è¨æ‘©äºš', code: 'Samoa' },
            { name: 'åœ£é©¬åŠ›è¯º', code: 'San Marino' },
            { name: 'åœ£å¤šç¾å’Œæ™®æ—è¥¿æ¯”', code: 'Sao Tome and Principe' },
            { name: 'æ²™ç‰¹é˜¿æ‹‰ä¼¯', code: 'Saudi Arabia' },
            { name: 'å¡å†…åŠ å°”', code: 'Senegal' },
            { name: 'å¡å°”ç»´äºš', code: 'Serbia' },
            { name: 'å¡èˆŒå°”', code: 'Seychelles' },
            { name: 'å¡æ‹‰åˆ©æ˜‚', code: 'Sierra Leone' },
            { name: 'æ–°åŠ å¡', code: 'Singapore' },
            { name: 'æ–¯æ´›ä¼å…‹', code: 'Slovakia' },
            { name: 'æ–¯æ´›æ–‡å°¼äºš', code: 'Slovenia' },
            { name: 'æ‰€ç½—é—¨ç¾¤å²›', code: 'Solomon Islands' },
            { name: 'ç´¢é©¬é‡Œ', code: 'Somalia' },
            { name: 'å—é', code: 'South Africa' },
            { name: 'éŸ©å›½', code: 'South Korea' },
            { name: 'å—è‹ä¸¹', code: 'South Sudan' },
            { name: 'è¥¿ç­ç‰™', code: 'Spain' },
            { name: 'æ–¯é‡Œå…°å¡', code: 'Sri Lanka' },
            { name: 'è‹ä¸¹', code: 'Sudan' },
            { name: 'è‹é‡Œå—', code: 'Suriname' },
            { name: 'ç‘å…¸', code: 'Sweden' },
            { name: 'ç‘å£«', code: 'Switzerland' },
            { name: 'å™åˆ©äºš', code: 'Syria' },
            { name: 'å¡”å‰å…‹æ–¯å¦', code: 'Tajikistan' },
            { name: 'å¦æ¡‘å°¼äºš', code: 'Tanzania' },
            { name: 'ä¸œå¸æ±¶', code: 'Timor-Leste' },
            { name: 'å¤šå“¥', code: 'Togo' },
            { name: 'æ±¤åŠ ', code: 'Tonga' },
            { name: 'ç‰¹ç«‹å°¼è¾¾å’Œå¤šå·´å“¥', code: 'Trinidad and Tobago' },
            { name: 'çªå°¼æ–¯', code: 'Tunisia' },
            { name: 'åœŸè€³å…¶', code: 'Turkey' },
            { name: 'åœŸåº“æ›¼æ–¯å¦', code: 'Turkmenistan' },
            { name: 'å›¾ç“¦å¢', code: 'Tuvalu' },
            { name: 'ä¹Œå¹²è¾¾', code: 'Uganda' },
            { name: 'ä¹Œå…‹å…°', code: 'Ukraine' },
            { name: 'é˜¿æ‹‰ä¼¯è”åˆé…‹é•¿å›½', code: 'United Arab Emirates' },
            { name: 'è‹±å›½', code: 'United Kingdom' },
            { name: 'ä¹Œæ‹‰åœ­', code: 'Uruguay' },
            { name: 'ä¹Œå…¹åˆ«å…‹æ–¯å¦', code: 'Uzbekistan' },
            { name: 'ç“¦åŠªé˜¿å›¾', code: 'Vanuatu' },
            { name: 'æ¢µè’‚å†ˆ', code: 'Vatican City' },
            { name: 'å§”å†…ç‘æ‹‰', code: 'Venezuela' },
            { name: 'è¶Šå—', code: 'Vietnam' },
            { name: 'ä¹Ÿé—¨', code: 'Yemen' },
            { name: 'èµæ¯”äºš', code: 'Zambia' },
            { name: 'æ´¥å·´å¸ƒéŸ¦', code: 'Zimbabwe' }
        ];

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const countrySelect = document.getElementById('countrySelect');
        const queryInput = document.getElementById('queryInput');
        const generateBtn = document.getElementById('generateBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const responseTextDiv = document.getElementById('responseText');
        const sourcesContainer = document.getElementById('sourcesContainer');
        const sourcesList = document.getElementById('sourcesList');

        // --- å·¥å…·å‡½æ•° ---

        /**
         * å¡«å……å›½å®¶ä¸‹æ‹‰æ¡†
         */
        function populateCountries() {
            // å¯¹å›½å®¶åˆ—è¡¨è¿›è¡Œæ’åºï¼Œæ–¹ä¾¿æŸ¥æ‰¾
            const sortedCountries = ALL_COUNTRIES.sort((a, b) => a.name.localeCompare(b.name, 'zh'));
            
            countrySelect.innerHTML = sortedCountries.map(country => 
                `<option value="${country.name}" data-code="${country.code}">${country.name}</option>`
            ).join('');
            
            // é»˜è®¤é€‰æ‹©å†°å²›ï¼Œä¿æŒå¯¹æ‚¨å½“å‰è®¡åˆ’çš„å…³æ³¨
            countrySelect.value = 'å†°å²›';
            updateButtonState();
        }

        /**
         * æ£€æŸ¥è¾“å…¥å¹¶æ›´æ–°æŒ‰é’®çŠ¶æ€
         */
        function updateButtonState() {
            generateBtn.disabled = !queryInput.value.trim() || !countrySelect.value;
        }

        /**
         * æ ¼å¼åŒ– Markdown æ–‡æœ¬ä¸º HTML
         */
        function formatMarkdownToHtml(markdownText) {
            if (!markdownText) return '';
            
            // 1. æ›¿æ¢æ®µè½æ¢è¡Œç¬¦ä¸º <br>
            let htmlText = markdownText.trim().replace(/\n/g, '<br>');

            // 2. æ›¿æ¢ Markdown æ ‡é¢˜ (#, ##) ä¸º HTML æ ‡é¢˜
            htmlText = htmlText.replace(/^###\s*(.*)$/gm, '<h3 class="text-xl font-semibold mt-4 mb-2 text-indigo-600">$1</h3>');
            htmlText = htmlText.replace(/^##\s*(.*)$/gm, '<h2 class="text-2xl font-bold mt-6 mb-3 text-indigo-700">$1</h2>');
            htmlText = htmlText.replace(/^#\s*(.*)$/gm, '<h1 class="text-3xl font-extrabold mt-8 mb-4 text-indigo-800">$1</h1>');

            // 3. æ›¿æ¢ **ç²—ä½“** ä¸º <strong>
            htmlText = htmlText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 4. å¤„ç†æ— åºåˆ—è¡¨
            const lines = htmlText.split('<br>');
            let inList = false;
            let finalHtml = [];

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ')) {
                    if (!inList) {
                        finalHtml.push('<ul class="list-disc list-inside ml-4 space-y-1">');
                        inList = true;
                    }
                    // Remove the bullet and wrap in <li>
                    finalHtml.push(`<li>${trimmedLine.substring(2).trim()}</li>`);
                } else {
                    if (inList) {
                        finalHtml.push('</ul>');
                        inList = false;
                    }
                    // Wrap regular lines in a paragraph tag (if not empty or a heading)
                    if (trimmedLine) {
                         if (!trimmedLine.startsWith('<h') && !trimmedLine.startsWith('<strong>')) {
                            finalHtml.push(`<p class="mb-3">${trimmedLine}</p>`);
                         } else {
                            finalHtml.push(trimmedLine);
                         }
                    }
                }
            });

            if (inList) {
                finalHtml.push('</ul>');
            }

            return finalHtml.join('');
        }
        
        // --- API è°ƒç”¨é€»è¾‘ ---

        /**
         * è°ƒç”¨ Gemini API å¹¶å®ç°æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
         */
        async function callGeminiAPI(payload, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            const text = candidate.content.parts[0].text;
                            let sources = [];
                            const groundingMetadata = candidate.groundingMetadata;
                            
                            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                                sources = groundingMetadata.groundingAttributions
                                    .map(attribution => ({
                                        uri: attribution.web?.uri,
                                        title: attribution.web?.title,
                                    }))
                                    .filter(source => source.uri && source.title);
                            }
                            
                            return { text, sources };

                        } else {
                            throw new Error("API response was valid but contained no generated text.");
                        }
                    } else if (response.status === 429 && i < retries - 1) {
                        // 429 Too Many Requests: wait and retry
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                        // Do not log retry as an error
                    } else {
                        // Other HTTP errors or last retry failed
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        console.error("Gemini API call failed after multiple retries:", error);
                        throw new Error("æ— æ³•è¿æ¥åˆ° AI æœåŠ¡ã€‚è¯·ç¨åå†è¯•ã€‚");
                    }
                    // Wait for the next retry
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }

        /**
         * ä¸»å¤„ç†å‡½æ•°ï¼šç”Ÿæˆæ—…è¡Œå»ºè®®
         */
        async function handleGenerate() {
            const selectedCountryName = countrySelect.value;
            // è·å–è‹±æ–‡/æ‹¼éŸ³ä»£ç ç”¨äºæœç´¢ä¼˜åŒ–
            const countryCode = countrySelect.options[countrySelect.selectedIndex].getAttribute('data-code'); 
            const userQuery = queryInput.value.trim();

            if (!selectedCountryName || !userQuery) return;

            // 1. æ¸…ç†å’Œè®¾ç½®çŠ¶æ€
            responseTextDiv.innerHTML = '';
            sourcesList.innerHTML = '';
            sourcesContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            generateBtn.disabled = true;

            const systemPrompt = "Act as a passionate and knowledgeable travel expert. Provide a detailed, easy-to-read travel guide or summary based on the user's query about the specified country. Structure your response with clear headings and bullet points where appropriate. All output MUST be in Chinese, including country names.";
            
            // 2. æ„å»ºæç¤º (åŒ…å«ä¸­æ–‡å’Œè‹±æ–‡/ä»£ç ä»¥æé«˜æœç´¢å‡†ç¡®æ€§)
            const fullPrompt = `è¯·ä¸ºæˆ‘æ€»ç»“å…³äº "${selectedCountryName} (${countryCode})" çš„æ—…è¡Œä¿¡æ¯ï¼š${userQuery}`;
            
            // 3. æ„å»º API Payload
            const payload = {
                contents: [{ parts: [{ text: fullPrompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                // 4. è°ƒç”¨ API
                const { text, sources } = await callGeminiAPI(payload);

                // 5. æ˜¾ç¤ºç»“æœ
                responseTextDiv.innerHTML = formatMarkdownToHtml(text);

                // 6. æ˜¾ç¤ºæ¥æº
                if (sources.length > 0) {
                    sources.forEach(source => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<a href="${source.uri}" target="_blank" class="text-indigo-500 hover:text-indigo-700 transition duration-150 ease-in-out truncate block" title="${source.title || source.uri}">${source.title || 'æ— æ ‡é¢˜é“¾æ¥'}</a>`;
                        sourcesList.appendChild(listItem);
                    });
                    sourcesContainer.classList.remove('hidden');
                } else {
                    sourcesContainer.classList.add('hidden');
                }

            } catch (error) {
                responseTextDiv.innerHTML = `<p class="text-red-500 font-medium">âš ï¸ å‘ç”Ÿé”™è¯¯ï¼š${error.message}</p>`;
                console.error(error);
            } finally {
                // 7. æ¢å¤çŠ¶æ€
                loadingIndicator.classList.add('hidden');
                updateButtonState();
            }
        }

        // --- äº‹ä»¶ç›‘å¬å™¨å’Œåˆå§‹åŒ– ---

        // ç»‘å®šäº‹ä»¶åˆ°ç”ŸæˆæŒ‰é’®
        generateBtn.addEventListener('click', handleGenerate);

        // å®æ—¶æ£€æŸ¥è¾“å…¥çŠ¶æ€
        queryInput.addEventListener('input', updateButtonState);

        // åˆå§‹åŒ–åº”ç”¨ç¨‹åº
        window.onload = () => {
            populateCountries();
        };

    </script>
</body>
</html>
